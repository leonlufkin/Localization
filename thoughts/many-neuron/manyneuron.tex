% GO TO: /Users/leonlufkin/Library/texmf/tex/latex
%        to add custom packages to the path
\documentclass{article}
\usepackage{report}

\title{Many-neuron Model}
\author{Leon Lufkin}
\date{\today}

\makeatletter
\let\Title\@title
\let\Author\@author
\let\Date\@date

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%
%% Many-neuron Model %%
%%%%%%%%%%%%%%%%%%%%%%%
\section{Many-neuron Model}
We have
\begin{align}
    \hat{y}(x) &= \frac{1}{K} \sum_{k=1}^{K} \relu(\langle w_k, x \rangle).
\end{align}
So, the loss is
\begin{align}
    \LL 
    &= \E_{X,Y}\left[ \left( Y - \frac{1}{K} \sum_{k=1}^{K} \relu(\langle w_k, X \rangle) \right)^2 \right] \\
    \begin{split}
        &= \E_{X,Y}\left[ Y^2 - \frac{2 Y}{K} \sum_{k=1}^{K} \relu(\langle w_k, x \rangle) + \frac{1}{K^2} \sum_{k=1}^{K} \relu^2(\langle w_k, x \rangle) + \right. \\
        &\hspace{1.5in} + \left. \frac{2}{K^2} \sum_{k>j} \relu(\langle w_k, x \rangle) \relu(\langle w_j, x \rangle) \right].
    \end{split}
\end{align}
We know how to work with the first two terms.
The third term is where interaction effects factor in.
Let us focus, then, on computing
\begin{align}
    (\dagger) &= \E \left[ \relu(\langle w, X \rangle) \relu(\langle v, X \rangle) \right].
\end{align}

For non-Gaussian data, this doesn't seem tractable, but let me consider it for Gaussian data.
Define $W \triangleq \langle w, X \rangle$ and $V \triangleq \langle v, X \rangle$.
Then,
\begin{align}
   \begin{pmatrix} W \\ V \end{pmatrix} \sim \NN\left( \mathbf{0}, \begin{pmatrix} \sigma_{ww}^2 & \sigma_{wv}^2 \\ \sigma_{wv}^2 & \sigma_{vv}^2 \end{pmatrix} \right),
\end{align}
where $\sigma_{ww}^2 \triangleq w^\top \Sigma w$, $\sigma_{vv}^2 \triangleq v^\top \Sigma v$, and $\sigma_{wv}^2 \triangleq w^\top \Sigma v$.
Let us write $W = a V + S$, where $a = \sigma_{wv}^2 / \sigma_{vv}^2$ and $S \sim \NN(0, \sigma_{ss}^2)$ is independent of $V$, where $\sigma_{ss}^2 \triangleq \sigma_{ww}^2 - \sigma_{wv}^4 / \sigma_{vv}^2$.
Then,
\begin{align}
    (\dagger) 
    &= \E \left[ \relu(aV + S) \relu(V) \right] \\
    &= \E_S \big[ \underbrace{ \E_{V \mid S} \big[ \relu(aV + S) \relu(V) \big] }_{\triangleq (\dagger \dagger)} \big].
\end{align}
We compute $(\dagger \dagger)$.
\begin{align*}
    (\dagger \dagger)
    &= \int_{ \max(0, -S/a) }^{\infty} p_V(v) (av + S) v dv \\
    &= a \underbrace{ \int_{ C }^{\infty} p_V(v) v^2 dv }_{\triangleq A} + S \underbrace{ \int_{ C }^{\infty} p_V(v) v dv }_{\triangleq B}. & C \triangleq \max(0, -S/a)
\end{align*}
We compute $A$ and $B$ separately.
\begin{align*}
    A 
    &= \int_{ C }^{\infty} \frac{1}{\sqrt{2\pi} \sigma_{vv}} e^{-\frac{1}{2} \frac{v^2}{\sigma_{vv}^2} } v^2 dv \\
    &= \sigma_{vv}^2 \int_{ C / \sigma_{vv} }^{\infty} \frac{1}{\sqrt{2\pi}} e^{-\frac{1}{2} t^2 } t^2 dt & t = v / \sigma_{vv} \\
    &= \sigma_{vv}^2 \sqrt{\frac{\pi}{2}} \left[ 1 - \operatorname{erf}\left(\frac{ C / \sigma_{vv} }{\sqrt{2}}\right) + \frac{C}{\sigma_{vv}} e^{-\frac{C^2}{2 \sigma_{vv}^2}} \right].
\end{align*}
Additionally,
\begin{align*}
    B 
    &= \int_{ C }^{\infty} \frac{1}{\sqrt{2\pi} \sigma_{vv}} e^{-\frac{1}{2} \frac{v^2}{\sigma_{vv}^2} } v dv \\
    &= \int_{ C / \sigma_{vv} }^{\infty} \frac{1}{\sqrt{2\pi}} e^{-\frac{1}{2} t^2 } t dt & t = v / \sigma_{vv} \\
    &= \frac{\sigma_{vv}}{\sqrt{2\pi}} e^{-\frac{1}{2} \frac{v^2}{\sigma_{vv}^2} } v e^{ -\frac{C^2}{2 \sigma_{vv}^2} }.
\end{align*}
Thus,
\begin{align*}
    (\dagger \dagger)
    &= a \sigma_{vv}^2 \sqrt{\frac{\pi}{2}} \left[ 1 - \operatorname{erf}\left(\frac{ C / \sigma_{vv} }{\sqrt{2}}\right) + \frac{C}{\sigma_{vv}} e^{-\frac{C^2}{2 \sigma_{vv}^2}} \right] + S \frac{\sigma_{vv}}{\sqrt{2\pi}} e^{ -\frac{C^2}{2 \sigma_{vv}^2} }.
\end{align*}
Now we compute $(\dagger)$.
\begin{align*}
    2 (\dagger)
    &= \E_{S \mid S \geq 0} \left[ (\dagger \dagger) \right] + \E_{S \mid S < 0} \left[ (\dagger \dagger) \right].
\end{align*}
For $S \geq 0$, $C = 0$.
So, the first term is
\begin{align*}
    \E_{S \mid S \geq 0} \left[ (\dagger \dagger) \right]
    &= \E_{S \mid S \geq 0} \left[ a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} + S \frac{\sigma_{vv}}{\sqrt{2\pi}} \right] \\
    &= a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} + \frac{1}{\pi} \sigma_{ss} \sigma_{vv}.
    % &= \int_{0}^{\infty} \frac{1}{\sqrt{2\pi} \sigma_{ww}} e^{-\frac{1}{2} \frac{s^2}{\sigma_{ww}^2} } \left[ a \sigma_{vv} \sqrt{\frac{\pi}{2}} + s \right] ds \\
\end{align*}
For $S < 0$, $C = -S/a$.
So, the second term is
\begin{align*}
    &\E_{S \mid S < 0} \left[ (\dagger \dagger) \right] \\
    &= \E_{S \mid S < 0} \left[ a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} \left[ 1 - \operatorname{erf}\left(\frac{ -S }{\sqrt{2} a \sigma_{vv}}\right) - \frac{S}{a \sigma_{vv}} e^{-\frac{S^2}{2 a^2 \sigma_{vv}^2}} \right] + S e^{ -\frac{S^2}{2 a^2 \sigma_{vv}^2} } \right] \\
    &= \E_{S \mid S \geq 0} \left[ a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} \left[ 1 - \operatorname{erf}\left(\frac{ S }{\sqrt{2} a \sigma_{vv}}\right) + \frac{S}{a \sigma_{vv}} e^{-\frac{S^2}{2 a^2 \sigma_{vv}^2}} \right] - S e^{ -\frac{S^2}{2 a^2 \sigma_{vv}^2} } \right] \\
    &= \E_{S \mid S \geq 0} \left[ a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} \left[ 1 - \operatorname{erf}\left(\frac{ S }{\sqrt{2} a \sigma_{vv}}\right) \right] + \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) S e^{-\frac{S^2}{2 a^2 \sigma_{vv}^2}} \right] \\
    &= a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} \left( 1 -  \E_{S \mid S \geq 0} \left[ \operatorname{erf}\left(\frac{ S }{\sqrt{2} a \sigma_{vv}}\right) \right] \right) + \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) \E_{S \mid S \geq 0} \left[ S e^{ -\frac{S^2}{2 a^2 \sigma_{vv}^2} } \right] \\
    &= a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} \left( 1 -  \E_{Z \mid Z \geq 0} \left[ \operatorname{erf}\left(\frac{ Z }{\sqrt{2} (a \sigma_{vv} / \sigma_{ss})}\right) \right] \right) + \\
    &\hspace{1.5in} \sigma_{ss} \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) \E_{Z \mid Z \geq 0} \left[ V e^{ -\frac{V^2}{2 (a \sigma_{vv} \sigma_{ss})^2} } \right].
\end{align*}
The first expectation is
\begin{align*}
    \E_{Z \mid Z \geq 0} \left[ \operatorname{erf}\left(\frac{ Z }{\sqrt{2} (a \sigma_{vv} / \sigma_{ss})}\right) \right]
    &= \int_{0}^{\infty} \frac{2}{\sqrt{2\pi}} e^{-\frac{1}{2} z^2} \operatorname{erf}\left(\frac{ z }{\sqrt{2} (a \sigma_{vv} / \sigma_{ss})}\right) dz \\
    &= \frac{2}{\sqrt{2\pi}} \left[ \sqrt{\pi} - \sqrt{\frac{2}{\pi}} \tan^{-1} \left( \frac{ 1 }{ 2 a \sigma_{vv} / \sigma_{ss} } \right) \right] \\
    &= \sqrt{2} - \frac{1}{\pi} \tan^{-1} \left( \frac{ \sigma_{ss} }{ 2 a \sigma_{vv} } \right).
\end{align*}
The second expectation is
\begin{align*}
    \E_{Z \mid Z \geq 0} \left[ V e^{ -\frac{V^2}{2 (a \sigma_{vv} \sigma_{ss})^2} } \right]
    &= \int_{0}^{\infty} \frac{2}{\sqrt{2\pi}} e^{-\frac{1}{2} z^2} z e^{ -\frac{z^2}{2 (a \sigma_{vv} \sigma_{ss})^2} } dz \\
    &= \sqrt{\frac{2}{\pi}} \frac{1}{\frac{1}{a^2{\sigma}_{ss}^2{\sigma}_{vv}^2} + 1}.
\end{align*}
Putting this together, we have
\begin{align*}
    &\E_{S \mid S < 0} \left[ (\dagger \dagger) \right] \\
    &= a \sigma_{vv}^2\sqrt{\frac{\pi}{2}} \left( 1 - \left[ \sqrt{2} - \frac{1}{\pi} \tan^{-1} \left( \frac{ \sigma_{ss} }{ 2 a \sigma_{vv} } \right) \right] \right) + \sigma_{ss} \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) \left[ \sqrt{\frac{2}{\pi}} \frac{1}{\frac{1}{a^2{\sigma}_{ss}^2{\sigma}_{vv}^2} + 1} \right]. % \\
    % &= a \sigma_{vv} \sqrt{\frac{\pi}{2}} - a \sigma_{vv} \sqrt{\frac{\pi}{2}} \left[ \sqrt{2} - \frac{1}{\pi} \tan^{-1} \left( \frac{ \sigma_{ss} }{ 2 a \sigma_{vv} } \right) \right] + \sqrt{\frac{2}{\pi}}  \sigma_{ss}\frac{1}{\frac{1}{a^2{\sigma}_{ss}^2{\sigma}_{vv}^2} + 1} \\
\end{align*}

Therefore,
\begin{align*}
    \sqrt{2 \pi} (\dagger)
    &= \pi \left( 1 - \frac{1}{\sqrt{2}} \right)a \sigma_{vv}^2+ \sqrt{\frac{1}{2\pi}} \sigma_{ss} \sigma_{vv} \\
    &\qquad + \frac{a \sigma_{vv}}{2} \tan^{-1} \left( \frac{ \sigma_{ss} }{ 2 a \sigma_{vv} } \right) + \sigma_{ss} \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right)\frac{1}{\frac{1}{a^2{\sigma}_{ss}^2{\sigma}_{vv}^2} + 1} \\
    &= \left( 1 - \frac{1}{\sqrt{2}} \right) \pi (\sigma_{wv}^2 / \sigma_{vv}^2) \sigma_{vv}^2 + \sqrt{\frac{1}{2\pi}} \sigma_{vv} \sqrt{\sigma_{ww}^2 - \sigma_{wv}^4 / \sigma_{vv}^2} \\
    &\qquad + \frac{(\sigma_{wv}^2 / \sigma_{vv}^2) \sigma_{vv}}{2} \tan^{-1} \left( \frac{ \sqrt{\sigma_{ww}^2 - \sigma_{wv}^4 / \sigma_{vv}^2} }{ 2 (\sigma_{wv}^2 / \sigma_{vv}^2) \sigma_{vv} } \right) \\
    &\qquad + \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) \frac{\sqrt{\sigma_{ww}^2 - \sigma_{wv}^4 / \sigma_{vv}^2}}{\sigma_{wv}^2 / \sigma_{vv}^2} \frac{1}{\frac{1}{(\sigma_{wv}^2 / \sigma_{vv}^2)^2 {\sigma}_{ss}^2{\sigma}_{vv}^2} + 1} \\
    &= \left( 1 - \frac{1}{\sqrt{2}} \right) \pi \sigma_{wv}^2 + \sqrt{\frac{2}{\pi}} \sqrt{\sigma_{ww}^2 \sigma_{vv}^2 - \sigma_{wv}^4} \\
    &\qquad + \frac{\sigma_{wv}^2 / \sigma_{vv}}{2} \tan^{-1} \left( \frac{ \sqrt{\sigma_{ww}^2 \sigma_{vv}^2 - \sigma_{wv}^4} }{ 2 \sigma_{wv}^2 } \right) \\
    &\qquad + \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) \frac{\sqrt{\sigma_{ww}^2 \sigma_{vv}^2 - \sigma_{wv}^4}}{\sigma_{wv}^2 / \sigma_{vv}} \frac{1}{\frac{1}{\sigma_{wv}^4 {\sigma}_{ss}^2 / \sigma_{vv}^2} + 1} \\
    &= \pi \left( 1 - \frac{1}{\sqrt{2}} \right) \sigma_{wv}^2 + \sqrt{\frac{1}{2\pi}} \sqrt{|\Sigma|}
    + \frac{\sigma_{wv}^2}{2 \sigma_{vv}} \tan^{-1} \left( \frac{ \sqrt{|\Sigma|} }{ 2 \sigma_{wv}^2 } \right) \\
    &\qquad + \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) \sqrt{|\Sigma|} \frac{\sigma_{vv}}{\sigma_{wv}^2} \frac{1}{\frac{1}{\sigma_{wv}^4 {\sigma}_{ss}^2 / \sigma_{vv}^2} + 1} \\
    &= \pi \left( 1 - \frac{1}{\sqrt{2}} \right) \sigma_{wv}^2 + \sqrt{\frac{1}{2\pi}} \sqrt{|\Sigma|}
    + \frac{\sigma_{wv}^2}{2 \sigma_{vv}} \tan^{-1} \left( \frac{ \sqrt{|\Sigma|} }{ 2 \sigma_{wv}^2 } \right) \\
    &\qquad + \left( \sqrt{\frac{\pi}{2}} \sigma_{vv} - 1 \right) \sqrt{|\Sigma|} \frac{\sigma_{wv}^2}{\frac{\sigma_{vv}}{{\sigma}_{ss}^2} + \frac{\sigma_{wv}^4}{\sigma_{vv}}}.
\end{align*}

If $\sigma_{wv} = 0$, then $\sigma_{ss} = \sigma_{ww}$ and $a = 0$.
Per the first line from above, we simply have
\begin{align*}
    (\dagger)
    &= \frac{1}{2 \pi} \sigma_{ww} \sigma_{vv},
\end{align*}
which makes sense.
(Shouldn't it be $1/2\pi$?)
If $\sigma_{wv} = \sigma_{vv}$, then $\sigma_{ss} = |\Sigma| = 0$ and $a = 1$.
So,
\begin{align*}
   (\dagger)
    &= \sqrt{\frac{\pi}{2}} \left( 1 - \frac{1}{\sqrt{2}} \right) \sigma_{vv}^2.
\end{align*}
This doesn't seem quite right... 
Shouldn't it be $\frac{1}{2} \sigma_{vv}^2$?

After some Desmosing, it has the (unsurprising?) form:
\begin{align*}
    (\dagger)
    &= f(\rho) \sigma_{vv} \sigma_{ww},
\end{align*}
where $$ \rho = \frac{\sigma_{wv}^2}{\sigma_{vv} \sigma_{ww}}. $$
Thus,
\begin{align*}
    \dd{(\dagger)}{w}
    &= \left[ \dd{f(\rho)}{w} \right] \sigma_{vv} \sigma_{ww} + f(\rho) \left[ \dd{\sigma_{vv}}{w} \sigma_{ww} + \sigma_{vv} \dd{\sigma_{ww}}{w} \right] \\
    &= f'(\rho) \dd{\rho}{w} \sigma_{vv} \sigma_{ww} + f(\rho) \left[ 0 \cdot \sigma_{ww} + \sigma_{vv} \cdot \frac{\Sigma w}{\sqrt{w^\top \Sigma w}} \right].
\end{align*}
We have
\begin{align*}
    \dd{\rho}{w_i}
    &= \frac{ 2 \sigma_{vv} \sigma_{ww} (\Sigma v)_i - \sigma_{wv}^2 \sigma_{vv} \left( \frac{\Sigma w}{\sqrt{w^\top \Sigma w}} \right)_i }{ \sigma_{vv}^2 \sigma_{ww}^2 }.
\end{align*}
As a vector,
\begin{align*}
    \dd{\rho}{w}
    &= \Sigma \left[ \frac{ 2 }{ \sigma_{vv} \sigma_{ww} } v
    - \frac{ \sigma_{wv}^2 }{ \sigma_{vv} \sigma_{ww}^3 } w \right].
\end{align*}
Thus,
\begin{align*}
    \dd{(\dagger)}{w}
    % &= \Sigma \left( f'(\rho) \left[ 2 v - \frac{ \sigma_{wv}^2 }{ \sigma_{ww}^2 } w \right] + f(\rho) \frac{\sigma_{vv}}{\sigma_{ww}} w \right).
    &= \Sigma \left( f'(\rho) \left[ 2 v - \rho \frac{ \sigma_{vv} }{ \sigma_{ww} } w \right] + f(\rho) \frac{\sigma_{vv}}{\sigma_{ww}} w \right).
\end{align*}
At $\rho = 0$, it seems $f(\rho) = 1/2\pi$ and $f'(\rho) = 1/4$.
Take $\sigma_{vv} = \sigma_{ww}$.
Then,
\begin{align*}
    \dd{(\dagger)}{w}
    &= \Sigma \left( \frac{1}{2} v + \frac{1}{2\pi} w \right),
\end{align*}
which doesn't seem right, since there should be no dependence on $v$ as a vector.

\end{document}
